# Klipper printer.cfg for Duet 3 Mini 5+ running a heavily modified Creality CR-10S Pro printer
# Refer to https://github.com/ReXT3D/cr-10s-pro-mods/tree/duet3d for custom ribbon cable transfer board & wiring
# Refer to https://www.thingiverse.com/thing:4841999 for custom Duet 3 Mini 5+ installation bracket
#
# Credits to Luke Ashley Luke@Lukeslab.online for getting Klipper running on the Duet 3 Mini 5+
#
#
# To compile the microcontroller code, use ATSAMD51P20, 25 MHz external crystal, and 16kib bootloader.
# For the initial Klipper flash only, plug in your Duet 3 and enter bootloader mode by quickly doubletapping the reset button.
# Flash with the following commands: sudo service klipper stop; make flash FLASH_DEVICE=/dev/ttyACM0; sudo service klipper start.
# It will appear as "usb-Klipper_samd51p20a" in .../by-id, and should be ready to go!
#
# Duet 3 Doesn't assign specific IO to any particular connectors so there isn't any particular order in how you connect your interfaces.
# Current pinmap can be found at https://github.com/Duet3D/RepRapFirmware/blob/3.3-dev/src/Duet3Mini/Pins_Duet3Mini.h for reference.
#
# Pins for reference:
# Driver Step Pins - 0:PC26, 1:PC25, 2:PC24, 3:PC19, 4:PC16, 5:PC30, 6:PC18
# Driver Dir pins - 0:PB3, 1:PB29, 2:PB28, 3:PD20, 4:PD21, 5:PB0, 6:PA27
# Driver Enable - !PC28
# Uart addresses - 0:0 1:1 2:2 3:3 4:!0 5:!1 6:!2 | "!" is for inverted select pin
# Thermistor Pins - T0:PC0, T1:PC1, T2:PC2
# Vssa Sense:PB4 | Vref Sense:PB5
# Current Sense resistor for drivers - .076ohm
# SPI lines:{PD11, PC7} -> Shared SerCom#7, SPIMosi:PC12, SPIMiso:PC15, SPISCLK:PC13
# Vin Monitor:PC3, uses 11:1 voltage divider
# LED's - Diag:PA31, Act:PA30
# 12864 LCD - LCDCSPIN:PC6, ENCA:PC11, ENCB:PD1, ENCSW:PB9, LCD A0:PA2, LCDBeep:PA0, LCD Neopixel Out:PB12 (shared with IO3.out)
# Neopixel Out - PA8
# Serial0 - TX:PB25, RX:PB24 (USB)
# Serial1 - TX:PB31, RX:PB30
# SBC SPISS pin:PA6, SBCTfrReady:PA3, SerComPins:{PA4, PA5, PA6, PA7}
# CAN Pins - TX:PB14 RX:PB15
# Heaters, Fan outputs - {Out0:PB17 Out1:PC10 Out2:PB13 Out3:PB11 Out4:PA11, Out5:PB2, Out6:PB1} | Out6 is shared with VFD_Out
# GPIO_out - {IO1:PB31 IO2:PD9 IO3:PB12 IO4:PD10} IO4 is shared with PSON
# GPIO_in - {IO1:PB30 IO2:PD8 IO3:PB7 IO4:PC5 IO5:PC4 IO6:PC31}
# Driver Diag - {D0:PA10, D1:PB8, D2:PA22, D3:PA23, D4:PC21, D5:PB10, D6:PA27}
# Mux Pin - PD0
# EXP headers only support 12864 LCD's


[stepper_x]
## DRIVER0
step_pin: PC26
dir_pin: !PB3
enable_pin: !PC28
microsteps: 16
rotation_distance: 40.0
full_steps_per_rotation: 400
endstop_pin: PC4                        # IO5
position_endstop: -1.0                  # start the 300mm print surface at 5mm inset from 310mm X-sized bed edge
position_min: -1.0
position_max: 316.0                     # approximately 3mm margin to physical X-movement range of 320mm
homing_speed: 60.0
homing_retract_speed: 25.0              # reduced to prevent frame shock
homing_retract_dist: 5.0
second_homing_speed: 10.0               # reduced to get better accuracy (not critical)

[tmc2209 stepper_x]
uart_pin: PA1
tx_pin: PA0
select_pins: PD0
uart_address: 0
run_current: 1.0                        # 71% of Moons' MS17HA2P4200 rated 2A peak current
hold_current: 0.5                       # 50% of run current
sense_resistor: 0.056
#stealthchop_threshold: 0                # disable stealthChop
stealthchop_threshold: 0.01             # enable stealthChop when static
#stealthchop_threshold: 999999           # enable stealthChop


[stepper_y]
## DRIVER1
step_pin: PC25
dir_pin: PB29
enable_pin: !PC28
microsteps: 16
rotation_distance: 40.0
full_steps_per_rotation: 400
endstop_pin: PC31                       # IO6
position_endstop: -7.0                  # start the 300mm print surface at 10mm inset from 320mm Y-sized bed edge (requires correct Y-stop mechanical position adjustment)
position_min: -7.0
position_max: 306                       # approximately 2mm margin to physical Y-movement limit of 315mm (requires correct Y-stop mechanical position adjustment)
homing_speed: 60.0
homing_retract_speed: 25.0              # reduced to prevent frame shock
homing_retract_dist: 5.0
second_homing_speed: 10.0               # reduced to get better accuracy (not critical)

[tmc2209 stepper_y]
uart_pin: PA1
tx_pin: PA0
select_pins: PD0
uart_address: 1
run_current: 1.2                        # 85% of Moons' MS17HA6P4200 rated 2A peak current
hold_current: 0.6                       # 50% of run current
sense_resistor: 0.056
#stealthchop_threshold: 0                # disable stealthChop
stealthchop_threshold: 0.01             # enable stealthChop when static
#stealthchop_threshold: 999999           # enable stealthChop


[stepper_z]
## DRIVER2, LHS
step_pin: PC24
dir_pin: PB28
enable_pin: !PC28
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_min: -0.2                      # slightly negative to allow for z_offset adjustment
position_max: 350                       # limit the Z build space to minimise bowden and wire harness rub against the top frame
homing_speed: 6.0                       # can use higher initial approach speed with BL Touch
homing_retract_speed: 4.0
homing_retract_dist: 3.0                # allow sufficient distance for BL Touch probe
second_homing_speed: 2.0                # slowed down for improved accuracy

[tmc2209 stepper_z]
uart_pin: PA1
tx_pin: PA0
select_pins: PD0
uart_address: 2
run_current: 0.45                       # stock Creality Z stepper
hold_current: 0.2                       # high hold current not required with anti-backlash nuts
sense_resistor: 0.056
#stealthchop_threshold: 0                # disable stealthChop
#stealthchop_threshold: 0.01             # enable stealthChop when static
stealthchop_threshold: 999999           # enable stealthChop


[stepper_z1]
## DRIVER3, RHS
step_pin: PC19
dir_pin: PD20
enable_pin: !PC28
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PA1
tx_pin: PA0
select_pins: PD0
uart_address: 3
run_current: 0.45                       # stock Creality Z stepper
hold_current: 0.2                       # high hold current not required with anti-backlash nuts
sense_resistor: 0.056
#stealthchop_threshold: 0                # disable stealthChop
#stealthchop_threshold: 0.01             # enable stealthChop when static
stealthchop_threshold: 999999           # enable stealthChop


[adc_scaled vref_scaled]
## enable analog sensor adjustments using VREF/VSSA pins
vref_pin: PB5
vssa_pin: PB4


[thermistor Trianglelab NTC100K B3950]
## values calibrated against a PT100 reference
temperature1: 25.0
resistance1: 103180.0
temperature2: 150.0
resistance2: 1366.2
temperature3: 250.0
resistance3: 168.6

[extruder]
## DRIVER4
step_pin: PC16
dir_pin: !PD21
enable_pin: !PC28
microsteps: 16
#rotation_distance: 22.857              # factory configuration of 140 steps/mm that underextrudes (98 mm instead of 100 mm)
rotation_distance: 22.3552              # actual rotation distance corrected by measurement with PLA filament (143.14 steps/mm or 1.02245 increase)
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC10                        # OUT1
sensor_type: Trianglelab NTC100K B3950
pullup_resistor: 2200                   # the board uses a 2.2kOhm pullup to work with a PT1000
sensor_pin: vref_scaled:PC1             # TEMP1
smooth_time: 0.4                        # optimized to reduce hot end temperature oscillation
control: pid
pid_Kp = 25.976                         # Micro Swiss hot end @ 225C with 50W heater & ReXT3D cooling duct @ 30% flow
pid_Ki = 1.991                          # Micro Swiss hot end @ 225C with 50W heater & ReXT3D cooling duct @ 30% flow
pid_Kd = 84.747                         # Micro Swiss hot end @ 225C with 50W heater & ReXT3D cooling duct @ 30% flow
min_temp: 10.0
max_temp: 280.0
min_extrude_temp: 170.0
max_extrude_only_distance: 500.0
#max_extrude_only_velocity: 70.0
#max_extrude_only_accel: 1000.0
max_extrude_only_velocity: 150.0
max_extrude_only_accel: 5000.0
#pressure_advance: 0.428                 # Canadian Maker ToughPLA low sheen black @ 220 C
#pressure_advance: 0.536                 # Canadian Maker ToughPLA low sheen black @ 200 C
pressure_advance: 0.640                 # Canadian Maker ToughPLA low sheen black @ 205 C, 0.28mm layer height (2021-06-22)

[tmc2209 extruder]
uart_pin: PA1
tx_pin: PA0
uart_address: 0
select_pins: !PD0
run_current: 1.1                        # 75% of Moons' MS17HD2P4200 rated 2A peak current
hold_current: 0.8                       # 75% of run current to hold against potential back-pressure
sense_resistor: 0.056
stealthchop_threshold: 0                # disable stealthChop
#stealthchop_threshold: 0.001            # enable stealthChop when static
#stealthchop_threshold: 999999           # enable stealthChop


[heater_bed]
heater_pin: PB17                        # OUT0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: vref_scaled:PC0             # TEMP0
pullup_resistor: 2200
control: pid
pid_Kp = 69.530                         # Creality borosilicate glass bed
pid_Ki = 1.717                          # Creality borosilicate glass bed
pid_Kd = 703.995                        # Creality borosilicate glass bed
min_temp: 10
max_temp: 110
max_power: 0.8                          # slow down heating to minimize transient bed warping


[heater_fan Heatbreak_Fan]
pin: PA11                               # OUT4
max_power: 1.0
fan_speed: 1.00                          # full cooling not required with Micro Swiss hot end but running full to stop Orion fan noise
cycle_time: 0.010
kick_start_time: 0.250
heater: extruder
heater_temp: 50.0

[controller_fan Duet_5_Mini_Fan]
pin: PB2                                # OUT5
max_power: 1.0
fan_speed: 0.7                          # full cooling not required
kick_start_time: 0.250
idle_timeout: 120
idle_speed: 0.6                         # slow down when idling
heater: extruder, heater_bed

[fan]
pin: PB11                               # OUT3
kick_start_time: 0.250
off_below: 0.1                          # stock Creality part fan is unreliable below 10% speed request


[bltouch]
sensor_pin: PD8                         # IO2
control_pin: PD9                        # IO2
x_offset: -28.0                         # as measured on the printer, the offset is actually 28mm
y_offset: -4.0                          # BL Touch pin is 4mm closer to the bed front than the nozzle
z_offset = 2.22                         # Creality OEM metal bracket for BL Touch with Micro Swiss hot end
stow_on_each_sample: False
probe_with_touch_mode: True
speed: 2.0
samples: 2
sample_retract_dist: 3.0

#[safe_z_home]
#home_xy_position: 178,154               # 300x300 print area with BL Touch X and Y offsets
#speed: 80.0                             # speed-up from default 50 mm/s
#z_hop: 10.0
#z_hop_speed: 10.0


[homing_override]
## reduce the Z stepper motor homing current to minimize print head crash damage
axes: z
set_position_z: 0.0                      # set current position to zero as reference for Z hop
gcode:
    G90  ; absolute position mode
    G1 Z10  ; Z hop (lift Z) 10mm 
    G28 X Y  ; home X&Y axes first
    ; move BL Touch to the center of the bed (including offsets), then reset and clear it
    G1 X178 Y154 F4800
    BLTOUCH_DEBUG COMMAND=reset
    BLTOUCH_DEBUG COMMAND=pin_up 
    ; reduce current of Z motors, home Z then restore original current of Z motors
    SET_TMC_CURRENT STEPPER=stepper_z  CURRENT=0.2 HOLDCURRENT=0.2
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.2 HOLDCURRENT=0.2
    G28 Z
    SET_TMC_CURRENT STEPPER=stepper_z  CURRENT={ printer.configfile.config["tmc2209 stepper_z"]["run_current"] }  HOLDCURRENT={ printer.configfile.config["tmc2209 stepper_z"]["hold_current"] }
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={ printer.configfile.config["tmc2209 stepper_z1"]["run_current"] } HOLDCURRENT={ printer.configfile.config["tmc2209 stepper_z1"]["hold_current"] }
    G1 Z10 F600 ; Z hop (lift Z) 10mm


[mcu]
serial: /dev/serial/by-id/usb-Klipper_samd51p20a_8136650E484633532020204E081618FF-if00
restart_method: command


[temperature_sensor Raspberry_Pi]
sensor_type: temperature_host


[thermistor NTCLE305E4103SB]
## values from the Vishay data sheet
temperature1: 25.0
resistance1: 10000.0
temperature2: 75.0
resistance2: 1475.9
temperature3: 125.0
resistance3: 336.8

[temperature_sensor Duet_5_Mini]
## dedicated thermistor on TEMP2 measuring board temperature
sensor_type: NTCLE305E4103SB
sensor_pin: vref_scaled:PC2             # TEMP2
pullup_resistor: 2200                   # the board uses a 2.2kOhm pullup to work with a PT1000
min_temp: 0.0
max_temp: 110.0


[printer]
kinematics: cartesian
#max_velocity: 150                       # reduced for 0.9 degree Moons' steppers in StealthChop
max_velocity: 200.0                     # can easily use 200mm/s in SpreadCycle
max_accel: 2500.0                       # based on Klipper resonance test and shaper calibration
#max_accel: 10000                        # used for resonance measurement only
#max_accel_to_decel: 10000               # used for resonance measurement only
max_z_velocity: 15.0                    # increased to allow faster non printing moves
max_z_accel: 250.0

[input_shaper]
## upgraded CR-10S Pro with very well assembled and tuned mechanicals
shaper_freq_x: 80.0                     # based on Klipper resonance test and shaper calibration
shaper_freq_y: 35.2                     # based on Klipper resonance test and shaper calibration
shaper_type_x: zv
shaper_type_y: mzv

[firmware_retraction]
#retract_length: 1.3                    # Canadian Maker ToughPLA low sheen black @ 205 C, 20 mm/s
#retract_length: 1.5
retract_length: 1.4
retract_speed: 55.0
unretract_extra_length: 0.0
unretract_speed: 25.0


[z_tilt]
z_positions: -31, 150                   # stepper shaft axes are 362 mm apart and the 300mm print area is centered on X
  331, 150
points: 43, 154                         # +15mm initial probe point inset (includes BL Touch X and Y offsets)
   63, 154
  140, 154                              # lower point density in the middle of the bed
  216, 154
  293, 154
  313, 154                              # -15mm final probe point inset (includes BL Touch X and Y offsets)
horizontal_move_z: 5.0                  # additional clearance for BL Touch

[bed_mesh]
speed: 80.0
horizontal_move_z: 5.0                  # additional clearance for BL Touch
mesh_min: 12, 12                        # this clears edges and clips with 300x300 bed & ReXT3D or factory part cooling duct
mesh_max: 288, 288                      # this clears edges and clips with 300x300 bed & ReXT3D or factory part cooling duct
#probe_count: 5,5                        # use this for correct display with Creality touch LCD & DGUS Reloaded
#algorithm: lagrange                     # use this for correct display with Creality touch LCD & DGUS Reloaded
probe_count: 10,10
algorithm: bicubic
fade_start: 1
fade_end: 10

[bed_screws]
screw1: 23,28                           # exact screw location based on the X&Y endstops defined above 
screw2: 273,28                          # exact screw location based on the X&Y endstops defined above
screw3: 273,268                         # exact screw location based on the X&Y endstops defined above
screw4: 23,268                          # exact screw location based on the X&Y endstops defined above
horizontal_move_z: 10.0                 # increased clearance to account for non-level bed
probe_height: 0.2                       # use the Creality supplied 0.2mm feeler gauge for manual adjustment to avoid bed damage
speed: 80.0
probe_speed: 5.0                        # can approach faster than bed mesh probing for a coarse manual screw adjustment


[filament_switch_sensor e0_sensor]
switch_pin: PB7                         # IO3
pause_on_runout: False
runout_gcode:
  M600


[respond]
default_type: echo


[gcode_arcs]
## allow use of ArcWelder
resolution: 0.5


[mcu rpi]
## used for resonance measurement only
serial: /tmp/klipper_host_mcu

[adxl345]
## used for resonance measurement only
cs_pin: rpi:None

[resonance_tester]
## used for resonance measurement only
accel_chip: adxl345
probe_points:
  150,150,20


#[t5uid1]
#firmware: dgus_reloaded
#update_interval: 1
#machine_name: CR-10S Pro
#volume: 40
#brightness: 75
#x_min_inset: 26.0                       # 25mm inset from X=0
#x_max_inset: 41.0                       # 25mm inset from X=300
#y_min_inset: 37.0                       # 30mm inset from Y=0
#y_max_inset: 36.0                       # 30mm inset from Y=300
#z_min: 0                                # avoid accidental bed collisions
#z_max: 350                              # additional margin for LCD commanded moves


[include macros.cfg]                    # include macros

[include client.cfg]                    # include Fluidd client configuration
[include client_macros.cfg]             # include Fluidd client macros

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.072500, 0.067500, 0.066250, 0.060000, 0.072500, 0.067500, 0.087500, 0.095000, 0.105000, 0.112500
#*# 	  0.038750, 0.028750, 0.017500, 0.021250, 0.025000, 0.026250, 0.042500, 0.053750, 0.070000, 0.072500
#*# 	  0.033750, 0.022500, 0.006250, 0.006250, 0.012500, 0.006250, 0.022500, 0.033750, 0.045000, 0.065000
#*# 	  0.026250, 0.011250, 0.003750, 0.001250, 0.005000, 0.008750, 0.020000, 0.036250, 0.045000, 0.060000
#*# 	  0.060000, 0.041250, 0.027500, 0.027500, 0.035000, 0.027500, 0.038750, 0.041250, 0.062500, 0.072500
#*# 	  -0.001250, -0.021250, -0.041250, -0.040000, -0.030000, -0.033750, -0.021250, -0.017500, 0.002500, 0.002500
#*# 	  0.012500, -0.027500, -0.053750, -0.051250, -0.056250, -0.058750, -0.050000, -0.046250, -0.043750, -0.037500
#*# 	  0.050000, 0.011250, -0.017500, -0.026250, -0.027500, -0.040000, -0.035000, -0.038750, -0.038750, -0.042500
#*# 	  0.118750, 0.077500, 0.046250, 0.038750, 0.038750, 0.031250, 0.035000, 0.026250, 0.031250, 0.031250
#*# 	  0.033750, -0.010000, -0.046250, -0.056250, -0.052500, -0.065000, -0.065000, -0.070000, -0.071250, -0.068750
#*# tension = 0.2
#*# min_x = 12.0
#*# algo = bicubic
#*# y_count = 10
#*# mesh_y_pps = 2
#*# min_y = 12.0
#*# x_count = 10
#*# max_y = 287.94
#*# mesh_x_pps = 2
#*# max_x = 287.94
#*#
#*# [bed_mesh Borosilicate OLD]
#*# version = 1
#*# points =
#*# 	0.105000, 0.085000, 0.065000, 0.038750, 0.032500, 0.015000, 0.017500, 0.005000, 0.008750, -0.013750
#*# 	0.085000, 0.051250, 0.017500, 0.000000, -0.015000, -0.028750, -0.020000, -0.026250, -0.021250, -0.027500
#*# 	0.076250, 0.053750, 0.022500, -0.003750, -0.008750, -0.022500, -0.007500, -0.007500, 0.006250, 0.001250
#*# 	0.075000, 0.041250, 0.000000, -0.015000, -0.020000, -0.027500, -0.011250, -0.008750, 0.007500, 0.018750
#*# 	0.093750, 0.063750, 0.035000, 0.015000, 0.016250, 0.011250, 0.040000, 0.052500, 0.066250, 0.071250
#*# 	0.036250, -0.002500, -0.035000, -0.050000, -0.052500, -0.043750, -0.023750, -0.008750, 0.011250, 0.026250
#*# 	-0.007500, -0.030000, -0.041250, -0.067500, -0.055000, -0.050000, -0.017500, -0.001250, 0.031250, 0.035000
#*# 	0.016250, -0.010000, -0.035000, -0.043750, -0.037500, -0.030000, 0.002500, 0.022500, 0.051250, 0.068750
#*# 	0.053750, 0.037500, 0.040000, 0.036250, 0.053750, 0.068750, 0.113750, 0.141250, 0.175000, 0.182500
#*# 	-0.075000, -0.093750, -0.098750, -0.092500, -0.078750, -0.055000, -0.017500, 0.005000, 0.026250, 0.047500
#*# tension = 0.2
#*# mesh_x_pps = 2
#*# algo = bicubic
#*# min_x = 12.0
#*# min_y = 12.0
#*# y_count = 10
#*# mesh_y_pps = 2
#*# x_count = 10
#*# max_x = 287.94
#*# max_y = 287.94
#*#
#*# [bed_mesh Borosilicate NEW]
#*# version = 1
#*# points =
#*# 	  0.072500, 0.067500, 0.066250, 0.060000, 0.072500, 0.067500, 0.087500, 0.095000, 0.105000, 0.112500
#*# 	  0.038750, 0.028750, 0.017500, 0.021250, 0.025000, 0.026250, 0.042500, 0.053750, 0.070000, 0.072500
#*# 	  0.033750, 0.022500, 0.006250, 0.006250, 0.012500, 0.006250, 0.022500, 0.033750, 0.045000, 0.065000
#*# 	  0.026250, 0.011250, 0.003750, 0.001250, 0.005000, 0.008750, 0.020000, 0.036250, 0.045000, 0.060000
#*# 	  0.060000, 0.041250, 0.027500, 0.027500, 0.035000, 0.027500, 0.038750, 0.041250, 0.062500, 0.072500
#*# 	  -0.001250, -0.021250, -0.041250, -0.040000, -0.030000, -0.033750, -0.021250, -0.017500, 0.002500, 0.002500
#*# 	  0.012500, -0.027500, -0.053750, -0.051250, -0.056250, -0.058750, -0.050000, -0.046250, -0.043750, -0.037500
#*# 	  0.050000, 0.011250, -0.017500, -0.026250, -0.027500, -0.040000, -0.035000, -0.038750, -0.038750, -0.042500
#*# 	  0.118750, 0.077500, 0.046250, 0.038750, 0.038750, 0.031250, 0.035000, 0.026250, 0.031250, 0.031250
#*# 	  0.033750, -0.010000, -0.046250, -0.056250, -0.052500, -0.065000, -0.065000, -0.070000, -0.071250, -0.068750
#*# tension = 0.2
#*# min_x = 12.0
#*# algo = bicubic
#*# y_count = 10
#*# mesh_y_pps = 2
#*# min_y = 12.0
#*# x_count = 10
#*# max_y = 287.94
#*# mesh_x_pps = 2
#*# max_x = 287.94
